import { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { partsAPI } from '../services/api';
import { useElectionStore } from '../store/election';
import { Button } from '../components/ui/button';
import { Input } from '../components/ui/input';
import { Label } from '../components/ui/label';
import { Textarea } from '../components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '../components/ui/card';
import { Badge } from '../components/ui/badge';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '../components/ui/dialog';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '../components/ui/select';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '../components/ui/table';
import { Progress } from '../components/ui/progress';
import { Skeleton } from '../components/ui/skeleton';
import { Spinner } from '../components/ui/spinner';
import {
  AlertTriangleIcon,
  ShieldAlertIcon,
  ShieldCheckIcon,
  ShieldIcon,
  SearchIcon,
  EditIcon,
  UsersIcon,
  BarChart3Icon,
  FilterIcon,
  DownloadIcon,
} from 'lucide-react';
import { toast } from 'sonner';
import { formatNumber, cn } from '../lib/utils';

interface Part {
  id: string;
  partNo: number;
  partNameEn: string;
  partNameLocal?: string;
  boothAddress?: string;
  totalVoters?: number;
  maleVoters?: number;
  femaleVoters?: number;
  vulnerability?: string;
  vulnerabilityReason?: string;
}

const VULNERABILITY_LEVELS = [
  { value: 'HIGH', label: 'High Risk', color: 'bg-red-500', textColor: 'text-red-600' },
  { value: 'MEDIUM', label: 'Medium Risk', color: 'bg-amber-500', textColor: 'text-amber-600' },
  { value: 'LOW', label: 'Low Risk', color: 'bg-green-500', textColor: 'text-green-600' },
  { value: 'NORMAL', label: 'Normal', color: 'bg-gray-400', textColor: 'text-gray-600' },
];

const VULNERABILITY_REASONS = [
  'Opposition stronghold',
  'Caste-based polarization',
  'Religious sensitivity',
  'Booth capturing history',
  'Law and order issues',
  'Border area',
  'Naxal affected',
  'Communal tension',
  'Anti-party sentiment',
  'Poor infrastructure',
  'Transportation issues',
  'Low voter turnout history',
  'Agent unavailability',
  'Other',
];

export function VulnerabilityPage() {
  const { selectedElectionId } = useElectionStore();
  const [search, setSearch] = useState('');
  const [filterLevel, setFilterLevel] = useState<string>('all');
  const [editPart, setEditPart] = useState<Part | null>(null);
  const [editFormData, setEditFormData] = useState({
    vulnerability: '',
    vulnerabilityReason: '',
    customReason: '',
  });
  const queryClient = useQueryClient();

  const { data: partsData, isLoading } = useQuery({
    queryKey: ['parts-vulnerability', selectedElectionId],
    queryFn: () => partsAPI.getAll(selectedElectionId!, { limit: 500 }),
    enabled: !!selectedElectionId,
  });

  const parts: Part[] = partsData?.data?.data || [];

  // Calculate vulnerability statistics
  const stats = useMemo(() => {
    const counts = { HIGH: 0, MEDIUM: 0, LOW: 0, NORMAL: 0 };
    const voterCounts = { HIGH: 0, MEDIUM: 0, LOW: 0, NORMAL: 0 };

    parts.forEach((part) => {
      const level = (part.vulnerability || 'NORMAL') as keyof typeof counts;
      counts[level]++;
      voterCounts[level] += part.totalVoters || 0;
    });

    const total = parts.length;
    const atRisk = counts.HIGH + counts.MEDIUM;
    const percentAtRisk = total > 0 ? Math.round((atRisk / total) * 100) : 0;

    return { counts, voterCounts, total, atRisk, percentAtRisk };
  }, [parts]);

  // Filter parts
  const filteredParts = useMemo(() => {
    return parts.filter((part) => {
      const matchesSearch =
        !search ||
        part.partNameEn?.toLowerCase().includes(search.toLowerCase()) ||
        part.partNo?.toString().includes(search);

      const matchesLevel =
        filterLevel === 'all' || (part.vulnerability || 'NORMAL') === filterLevel;

      return matchesSearch && matchesLevel;
    });
  }, [parts, search, filterLevel]);

  // Sort by vulnerability (HIGH first)
  const sortedParts = useMemo(() => {
    const order = { HIGH: 0, MEDIUM: 1, LOW: 2, NORMAL: 3 };
    return [...filteredParts].sort((a, b) => {
      const aLevel = (a.vulnerability || 'NORMAL') as keyof typeof order;
      const bLevel = (b.vulnerability || 'NORMAL') as keyof typeof order;
      return order[aLevel] - order[bLevel];
    });
  }, [filteredParts]);

  const updateMutation = useMutation({
    mutationFn: (data: { id: string; vulnerability: string; vulnerabilityReason?: string }) =>
      partsAPI.update(data.id, {
        vulnerability: data.vulnerability,
        vulnerabilityReason: data.vulnerabilityReason,
      }),
    onSuccess: () => {
      toast.success('Vulnerability status updated');
      setEditPart(null);
      queryClient.invalidateQueries({ queryKey: ['parts-vulnerability'] });
    },
    onError: (error: any) => {
      toast.error(error.response?.data?.error?.message || 'Failed to update');
    },
  });

  const handleEdit = (part: Part) => {
    setEditPart(part);
    setEditFormData({
      vulnerability: part.vulnerability || 'NORMAL',
      vulnerabilityReason: VULNERABILITY_REASONS.includes(part.vulnerabilityReason || '')
        ? part.vulnerabilityReason || ''
        : 'Other',
      customReason: !VULNERABILITY_REASONS.includes(part.vulnerabilityReason || '')
        ? part.vulnerabilityReason || ''
        : '',
    });
  };

  const handleSave = () => {
    if (!editPart) return;

    const reason =
      editFormData.vulnerabilityReason === 'Other'
        ? editFormData.customReason
        : editFormData.vulnerabilityReason;

    updateMutation.mutate({
      id: editPart.id,
      vulnerability: editFormData.vulnerability,
      vulnerabilityReason: reason,
    });
  };

  const getVulnerabilityBadge = (level?: string) => {
    switch (level) {
      case 'HIGH':
        return (
          <Badge variant="destructive" className="gap-1">
            <ShieldAlertIcon className="h-3 w-3" />
            High Risk
          </Badge>
        );
      case 'MEDIUM':
        return (
          <Badge variant="warning" className="gap-1">
            <ShieldIcon className="h-3 w-3" />
            Medium
          </Badge>
        );
      case 'LOW':
        return (
          <Badge variant="success" className="gap-1">
            <ShieldCheckIcon className="h-3 w-3" />
            Low Risk
          </Badge>
        );
      default:
        return (
          <Badge variant="secondary" className="gap-1">
            <ShieldIcon className="h-3 w-3" />
            Normal
          </Badge>
        );
    }
  };

  const handleExport = () => {
    const csvContent = [
      ['Part No', 'Part Name', 'Total Voters', 'Vulnerability', 'Reason'].join(','),
      ...sortedParts.map((part) =>
        [
          part.partNo,
          `"${part.partNameEn}"`,
          part.totalVoters || 0,
          part.vulnerability || 'NORMAL',
          `"${part.vulnerabilityReason || ''}"`,
        ].join(',')
      ),
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'vulnerability-report.csv';
    a.click();
    URL.revokeObjectURL(url);
    toast.success('Report exported');
  };

  if (!selectedElectionId) {
    return (
      <div className="flex flex-col items-center justify-center h-[60vh] text-center">
        <AlertTriangleIcon className="h-12 w-12 text-gray-400 mb-4" />
        <h2 className="text-xl font-semibold text-gray-700">No Election Selected</h2>
        <p className="text-gray-500 mt-2">Please select an election to manage vulnerability data.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold flex items-center gap-2">
            <ShieldAlertIcon className="h-6 w-6" />
            Vulnerability Management
          </h1>
          <p className="text-gray-500">
            Identify and manage vulnerable polling booths ({stats.total} total parts)
          </p>
        </div>
        <Button variant="outline" onClick={handleExport}>
          <DownloadIcon className="h-4 w-4 mr-2" />
          Export Report
        </Button>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-5 gap-4">
        <Card className="lg:col-span-1">
          <CardContent className="p-4">
            <div className="flex items-center gap-2">
              <div className="p-2 rounded-full bg-red-100">
                <ShieldAlertIcon className="h-5 w-5 text-red-600" />
              </div>
              <div>
                <p className="text-sm text-gray-500">High Risk</p>
                <p className="text-2xl font-bold text-red-600">{stats.counts.HIGH}</p>
                <p className="text-xs text-gray-400">
                  {formatNumber(stats.voterCounts.HIGH)} voters
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="lg:col-span-1">
          <CardContent className="p-4">
            <div className="flex items-center gap-2">
              <div className="p-2 rounded-full bg-amber-100">
                <ShieldIcon className="h-5 w-5 text-amber-600" />
              </div>
              <div>
                <p className="text-sm text-gray-500">Medium Risk</p>
                <p className="text-2xl font-bold text-amber-600">{stats.counts.MEDIUM}</p>
                <p className="text-xs text-gray-400">
                  {formatNumber(stats.voterCounts.MEDIUM)} voters
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="lg:col-span-1">
          <CardContent className="p-4">
            <div className="flex items-center gap-2">
              <div className="p-2 rounded-full bg-green-100">
                <ShieldCheckIcon className="h-5 w-5 text-green-600" />
              </div>
              <div>
                <p className="text-sm text-gray-500">Low Risk</p>
                <p className="text-2xl font-bold text-green-600">{stats.counts.LOW}</p>
                <p className="text-xs text-gray-400">
                  {formatNumber(stats.voterCounts.LOW)} voters
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="lg:col-span-1">
          <CardContent className="p-4">
            <div className="flex items-center gap-2">
              <div className="p-2 rounded-full bg-gray-100">
                <ShieldIcon className="h-5 w-5 text-gray-600" />
              </div>
              <div>
                <p className="text-sm text-gray-500">Normal</p>
                <p className="text-2xl font-bold text-gray-600">{stats.counts.NORMAL}</p>
                <p className="text-xs text-gray-400">
                  {formatNumber(stats.voterCounts.NORMAL)} voters
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="lg:col-span-1">
          <CardContent className="p-4">
            <div className="flex items-center gap-2">
              <div className="p-2 rounded-full bg-orange-100">
                <BarChart3Icon className="h-5 w-5 text-orange-600" />
              </div>
              <div>
                <p className="text-sm text-gray-500">At Risk</p>
                <p className="text-2xl font-bold text-orange-600">{stats.percentAtRisk}%</p>
                <p className="text-xs text-gray-400">{stats.atRisk} booths need attention</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Risk Distribution */}
      <Card>
        <CardHeader>
          <CardTitle>Risk Distribution</CardTitle>
          <CardDescription>Overview of vulnerability levels across all parts</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {VULNERABILITY_LEVELS.map((level) => {
              const count = stats.counts[level.value as keyof typeof stats.counts];
              const percent = stats.total > 0 ? Math.round((count / stats.total) * 100) : 0;

              return (
                <div key={level.value} className="space-y-1">
                  <div className="flex justify-between text-sm">
                    <span className={level.textColor}>{level.label}</span>
                    <span className="text-gray-500">
                      {count} parts ({percent}%)
                    </span>
                  </div>
                  <Progress value={percent} className={cn('h-2', level.color)} />
                </div>
              );
            })}
          </div>
        </CardContent>
      </Card>

      {/* Filters */}
      <Card>
        <CardContent className="p-4">
          <div className="flex flex-col md:flex-row gap-4">
            <div className="relative flex-1">
              <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
              <Input
                placeholder="Search parts..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="pl-9"
              />
            </div>
            <Select value={filterLevel} onValueChange={setFilterLevel}>
              <SelectTrigger className="w-[180px]">
                <FilterIcon className="h-4 w-4 mr-2" />
                <SelectValue placeholder="Filter by level" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Levels</SelectItem>
                {VULNERABILITY_LEVELS.map((level) => (
                  <SelectItem key={level.value} value={level.value}>
                    {level.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </CardContent>
      </Card>

      {/* Parts Table */}
      <Card>
        <CardContent className="p-0">
          {isLoading ? (
            <div className="p-4 space-y-4">
              {Array(10)
                .fill(0)
                .map((_, i) => (
                  <Skeleton key={i} className="h-12 w-full" />
                ))}
            </div>
          ) : sortedParts.length === 0 ? (
            <div className="p-8 text-center">
              <ShieldIcon className="h-12 w-12 text-gray-300 mx-auto mb-4" />
              <p className="text-gray-500">No parts found</p>
            </div>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Part No</TableHead>
                  <TableHead>Name</TableHead>
                  <TableHead>Total Voters</TableHead>
                  <TableHead>Vulnerability</TableHead>
                  <TableHead>Reason</TableHead>
                  <TableHead className="w-[100px]">Actions</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {sortedParts.map((part) => (
                  <TableRow
                    key={part.id}
                    className={cn(
                      part.vulnerability === 'HIGH' && 'bg-red-50/50',
                      part.vulnerability === 'MEDIUM' && 'bg-amber-50/50'
                    )}
                  >
                    <TableCell className="font-medium">{part.partNo}</TableCell>
                    <TableCell>
                      <div>{part.partNameEn}</div>
                      {part.partNameLocal && (
                        <div className="text-sm text-gray-500">{part.partNameLocal}</div>
                      )}
                    </TableCell>
                    <TableCell>
                      <div className="flex items-center gap-1">
                        <UsersIcon className="h-4 w-4 text-gray-400" />
                        {formatNumber(part.totalVoters || 0)}
                      </div>
                    </TableCell>
                    <TableCell>{getVulnerabilityBadge(part.vulnerability)}</TableCell>
                    <TableCell className="max-w-[200px] truncate text-sm text-gray-600">
                      {part.vulnerabilityReason || '-'}
                    </TableCell>
                    <TableCell>
                      <Button variant="ghost" size="icon" onClick={() => handleEdit(part)}>
                        <EditIcon className="h-4 w-4" />
                      </Button>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>

      {/* Edit Dialog */}
      <Dialog open={!!editPart} onOpenChange={(open) => !open && setEditPart(null)}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Update Vulnerability Status</DialogTitle>
            <DialogDescription>
              Part {editPart?.partNo} - {editPart?.partNameEn}
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>Vulnerability Level</Label>
              <Select
                value={editFormData.vulnerability}
                onValueChange={(v) => setEditFormData({ ...editFormData, vulnerability: v })}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select level" />
                </SelectTrigger>
                <SelectContent>
                  {VULNERABILITY_LEVELS.map((level) => (
                    <SelectItem key={level.value} value={level.value}>
                      <div className="flex items-center gap-2">
                        <div className={cn('h-3 w-3 rounded-full', level.color)} />
                        {level.label}
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label>Reason</Label>
              <Select
                value={editFormData.vulnerabilityReason}
                onValueChange={(v) => setEditFormData({ ...editFormData, vulnerabilityReason: v })}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select reason" />
                </SelectTrigger>
                <SelectContent>
                  {VULNERABILITY_REASONS.map((reason) => (
                    <SelectItem key={reason} value={reason}>
                      {reason}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {editFormData.vulnerabilityReason === 'Other' && (
              <div className="space-y-2">
                <Label>Custom Reason</Label>
                <Textarea
                  value={editFormData.customReason}
                  onChange={(e) =>
                    setEditFormData({ ...editFormData, customReason: e.target.value })
                  }
                  placeholder="Enter custom reason..."
                />
              </div>
            )}
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setEditPart(null)}>
              Cancel
            </Button>
            <Button onClick={handleSave} disabled={updateMutation.isPending}>
              {updateMutation.isPending && <Spinner size="sm" className="mr-2" />}
              Save Changes
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
